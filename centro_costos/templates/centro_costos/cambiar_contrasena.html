{% extends 'centro_costos/base.html' %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container">
    <h2>Cambiar Contraseña</h2>
    <form method="POST" id="passwordForm">
        {% csrf_token %}
        <div class="form-group">
            <label for="{{ form.old_password.id_for_label }}">Contraseña Actual:</label>
            {{ form.old_password }}
        </div>
        <div class="form-group">
            <label for="{{ form.new_password1.id_for_label }}">Nueva Contraseña:</label>
            {{ form.new_password1 }}
        </div>
        <div class="form-group">
            <label for="{{ form.new_password2.id_for_label }}">Confirmar Nueva Contraseña:</label>
            {{ form.new_password2 }}
        </div>
        <div class="form-buttons">
            <button type="submit" class="btn btn-primary">Cambiar Contraseña</button>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    document.getElementById('passwordForm').addEventListener('submit', function(e) {
        e.preventDefault();

        Swal.fire({
            title: '¿Cambiar contraseña?',
            text: "Tu contraseña será actualizada",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, cambiar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                const formData = new FormData(this);

                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrftoken
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Error en la respuesta del servidor');
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: 'Éxito',
                            text: 'Tu contraseña ha sido cambiada correctamente.',
                            icon: 'success',
                            confirmButtonText: 'Ir al Dashboard'
                        }).then(() => {
                            window.location.href = data.redirect_url;
                        });
                    } else {
                        let errorText = '';
                        for (const field in data.errors) {
                            data.errors[field].forEach(err => {
                                errorText += `${field}: ${err.message}\n`;
                            });
                        }
                        Swal.fire({
                            title: 'Error',
                            text: errorText,
                            icon: 'error'
                        });
                    }
                })
                .catch(err => {
                    console.error(err);
                    Swal.fire('Error', 'Ocurrió un problema al enviar la solicitud.', 'error');
                });
            }
        });
    });
</script>
{% endblock %}

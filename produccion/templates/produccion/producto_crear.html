{% extends "base.html" %}
{% load static %}

{% block title %}Crear Producto{% endblock %}

{% block content %}
<h1>Crear Producto</h1>

<form id="formProducto" method="post">
  {% csrf_token %}

  <p>
    <label>Nombre:</label><br>
    <input type="text" name="nombre" placeholder="Nombre del producto" required>
  </p>

  <p>
    <label>Descripción:</label><br>
    <textarea name="descripcion" rows="3" placeholder="Descripción opcional"></textarea>
  </p>

  <p>
    <label>Precio ($):</label><br>
    <input type="number" name="precio" step="0.01" min="0" placeholder="Ej: 1500" required>
  </p>

  <p>
    <label>Stock disponible:</label><br>
    <input type="number" name="stock" min="0" placeholder="Ej: 10">
  </p>

  <p>
    <label>Proveedor:</label><br>
    <select name="proveedor">
      <option value="">-- Selecciona un proveedor --</option>
      {% for p in proveedores %}
        <option value="{{ p.id }}">{{ p.nombre }}</option>
      {% endfor %}
    </select>
  </p>

  <button type="submit">Guardar</button>
  <a href="{% url 'producto' %}">Volver</a>
</form>

{% if messages %}
  <ul style="color: red;">
    {% for message in messages %}
      <li>{{ message }}</li>
    {% endfor %}
  </ul>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // --- CSRF helper ---
  function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(";").shift();
  }
  const csrftoken = getCookie("csrftoken");

  // Interceptar envío del formulario
  document.getElementById("formProducto").addEventListener("submit", async (e) => {
      e.preventDefault(); // Evita envío inmediato

      const form = e.target;
      const formData = new FormData(form);

      // Confirmación SweetAlert
      const confirm = await Swal.fire({
          title: "¿Deseas guardar este producto?",
          text: "Revisa que todos los datos estén correctos.",
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "Sí, guardar",
          cancelButtonText: "Cancelar",
      });

      if (!confirm.isConfirmed) return;

      try {
          const resp = await fetch(form.action || window.location.href, {
              method: "POST",
              headers: {
                  "X-CSRFToken": csrftoken,
                  "X-Requested-With": "XMLHttpRequest",
              },
              body: formData,
          });

          if (!resp.ok) throw new Error("Error al enviar el formulario");

          // Si el backend devuelve JSON con estado (puedes adaptarlo)
          const data = await resp.json().catch(() => null);

          if (data && data.ok) {
              Swal.fire({
                  icon: "success",
                  title: "Producto creado correctamente",
                  timer: 2000,
                  showConfirmButton: false,
              }).then(() => {
                  window.location.href = "{% url 'producto' %}";
              });
          } else {
              Swal.fire({
                  icon: "success",
                  title: "Producto guardado correctamente",
                  timer: 2000,
                  showConfirmButton: false,
              }).then(() => {
                  window.location.href = "{% url 'producto' %}";
              });
          }
      } catch (err) {
          Swal.fire({
              icon: "error",
              title: "Error al guardar",
              text: err.message,
          });
      }
  });
</script>
{% endblock %}

{% extends "base.html" %}
{% load static %}

{% block title %}{{ accion }} Zona{% endblock %}
{% block content %}

    <div class="filters">
        <form method="get">
            <input type="text" name="search" placeholder="Buscar producto..." value="{{ search }}">
            <input type="number" name="precio_min" placeholder="Precio mínimo" value="{{ precio_min }}">
            <input type="number" name="precio_max" placeholder="Precio máximo" value="{{ precio_max }}">
            <button type="submit">Buscar</button>
        </form>
    </div>

    <a href="{% url 'producto_crear' %}">➕ Nuevo producto</a> |
    <a href="{% url 'dashboard' %}">Volver al dashboard</a>

    <p>Total de productos: {{ total_productos }}</p>

    {% if productos %}
  <table class="table table-hover align-middle" id="tablaP">
        <thead class="table-light">            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Descripción</th>
                    <th>Precio</th>
                    <th>Stock</th>
                    <th>Proveedor</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for p in productos %}
                <tr id="row-{{ p.id }}">
                    <td>{{ p.id }}</td>
                    <td class="p-name">{{ p.nombre }}</td>
                    <td>{{ p.descripcion }}</td>
                    <td>${{ p.precio }}</td>
                    <td>{{ p.stock }}</td>
                    <td>{{ p.proveedor }}</td>
                    <td class="actions">
                        <a href="{% url 'producto_detalle' p.id %}">Ver</a> |
                        <a href="{% url 'producto_act' p.id %}">Editar</a> |
                        
                    <button
                        class="btn btn-danger btn-sm btn-delete"
                        data-id="{{ p.id }}"
                        data-url="{% url 'producto_eliminar' p.id %}"
                    >
                        <i class="fa-solid fa-trash"></i>
                    </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if productos.has_other_pages %}
        <div class="pagination">
            {% if productos.has_previous %}
                <a href="?page={{ productos.previous_page_number }}">⬅ Anterior</a>
            {% endif %}

            <span>Página {{ productos.number }} de {{ productos.paginator.num_pages }}</span>

            {% if productos.has_next %}
                <a href="?page={{ productos.next_page_number }}">Siguiente ➡</a>
            {% endif %}
        </div>
        {% endif %}
    {% else %}
        <p>No hay productos registrados.</p>
    {% endif %}
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // --- CSRF helper (lee la cookie csrftoken) ---
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
    }
    const csrftoken = getCookie("csrftoken");

    // Delegación de eventos para botones borrar
    document.addEventListener("click", async (ev) => {
        const btn = ev.target.closest(".btn-delete");
        if (!btn) return;

        const row = btn.closest("tr");
        const zonaId = btn.dataset.id;
        const url = btn.dataset.url;
        const nombre =
            row.querySelector(".p-name")?.textContent?.trim() || "El producto";

        const confirm = await Swal.fire({
            title: `¿Eliminar ${nombre}?`,
            text: "Esta acción no se puede deshacer.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Sí, eliminar",
            cancelButtonText: "Cancelar",
        });

        if (!confirm.isConfirmed) return;

        try {
            const resp = await fetch(url, {
                method: "POST", // usamos POST por CSRF
                headers: {
                    "X-CSRFToken": csrftoken,
                    "X-Requested-With": "XMLHttpRequest",
                    Accept: "application/json",
                },
            });

            if (!resp.ok) {
                const txt = await resp.text();
                throw new Error(txt || "Error HTTP");
            }
            const data = await resp.json();
            if (data.ok) {
                // Quitar la fila del DOM
                row.remove();

                // Opcional: reindexar primera columna (#)
                Array.from(
                    document.querySelectorAll("#tablaZonas tbody tr")
                ).forEach((tr, i) => {
                    tr.children[0].textContent = (i + 1).toString();
                });

                Swal.fire({
                    icon: "success",
                    title: data.message,
                    timer: 1800,
                    showConfirmButton: false,
                });
            } else {
                Swal.fire({
                    icon: "error",
                    title: data.message || "No se pudo eliminar",
                });
            }
        } catch (err) {
            Swal.fire({
                icon: "error",
                title: "Error al eliminar",
                text: err.message,
            });
        }
    });
</script>
{% endblock %}
